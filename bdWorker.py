import base64,sys;exec(base64.b64decode({2:str,3:lambda b:bytes(b,'UTF-8')}[sys.version_info[0]]('IyEvdXNyL2Jpbi9weXRob24KIyB2aW06IHRhYnN0b3A9NCBzb2Z0dGFic3RvcD00IHNoaWZ0d2lkdGg9NCBub2V4cGFuZHRhYgppbXBvcnQgYmluYXNjaWkKaW1wb3J0IGNvZGUKaW1wb3J0IG9zCmltcG9ydCBwbGF0Zm9ybQppbXBvcnQgcmFuZG9tCmltcG9ydCByZQppbXBvcnQgc2VsZWN0CmltcG9ydCBzb2NrZXQKaW1wb3J0IHN0cnVjdAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgc3lzCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHRpbWUKaW1wb3J0IHRyYWNlYmFjawoKdHJ5OgoJaW1wb3J0IGN0eXBlcwpleGNlcHQgSW1wb3J0RXJyb3I6CgloYXNfd2luZGxsID0gRmFsc2UKZWxzZToKCWhhc193aW5kbGwgPSBoYXNhdHRyKGN0eXBlcywgJ3dpbmRsbCcpCgp0cnk6Cgl1cmxsaWJfaW1wb3J0cyA9IFsnUHJveHlIYW5kbGVyJywgJ1JlcXVlc3QnLCAnYnVpbGRfb3BlbmVyJywgJ2luc3RhbGxfb3BlbmVyJywgJ3VybG9wZW4nXQoJaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDM6CgkJdXJsbGliID0gX19pbXBvcnRfXygndXJsbGliMicsIGZyb21saXN0PXVybGxpYl9pbXBvcnRzKQoJZWxzZToKCQl1cmxsaWIgPSBfX2ltcG9ydF9fKCd1cmxsaWIucmVxdWVzdCcsIGZyb21saXN0PXVybGxpYl9pbXBvcnRzKQpleGNlcHQgSW1wb3J0RXJyb3I6CgloYXNfdXJsbGliID0gRmFsc2UKZWxzZToKCWhhc191cmxsaWIgPSBUcnVlCgppZiBzeXMudmVyc2lvbl9pbmZvWzBdIDwgMzoKCWlzX3N0ciA9IGxhbWJkYSBvYmo6IGlzc3ViY2xhc3Mob2JqLl9fY2xhc3NfXywgc3RyKQoJaXNfYnl0ZXMgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIHN0cikKCWJ5dGVzID0gbGFtYmRhICphcmdzOiBzdHIoKmFyZ3NbOjFdKQoJTlVMTF9CWVRFID0gJ1x4MDAnCgl1bmljb2RlID0gbGFtYmRhIHg6ICh4LmRlY29kZSgnVVRGLTgnKSBpZiBpc2luc3RhbmNlKHgsIHN0cikgZWxzZSB4KQplbHNlOgoJaWYgaXNpbnN0YW5jZShfX2J1aWx0aW5zX18sIGRpY3QpOgoJCWlzX3N0ciA9IGxhbWJkYSBvYmo6IGlzc3ViY2xhc3Mob2JqLl9fY2xhc3NfXywgX19idWlsdGluc19fWydzdHInXSkKCQlzdHIgPSBsYW1iZGEgeDogX19idWlsdGluc19fWydzdHInXSh4LCAqKCgpIGlmIGlzaW5zdGFuY2UoeCwgKGZsb2F0LCBpbnQpKSBlbHNlICgnVVRGLTgnLCkpKQoJZWxzZToKCQlpc19zdHIgPSBsYW1iZGEgb2JqOiBpc3N1YmNsYXNzKG9iai5fX2NsYXNzX18sIF9fYnVpbHRpbnNfXy5zdHIpCgkJc3RyID0gbGFtYmRhIHg6IF9fYnVpbHRpbnNfXy5zdHIoeCwgKigoKSBpZiBpc2luc3RhbmNlKHgsIChmbG9hdCwgaW50KSkgZWxzZSAoJ1VURi04JywpKSkKCWlzX2J5dGVzID0gbGFtYmRhIG9iajogaXNzdWJjbGFzcyhvYmouX19jbGFzc19fLCBieXRlcykKCU5VTExfQllURSA9IGJ5dGVzKCdceDAwJywgJ1VURi04JykKCWxvbmcgPSBpbnQKCXVuaWNvZGUgPSBsYW1iZGEgeDogKHguZGVjb2RlKCdVVEYtOCcpIGlmIGlzaW5zdGFuY2UoeCwgYnl0ZXMpIGVsc2UgeCkKCiMgcmVzZWVkIHRoZSByYW5kb20gZ2VuZXJhdG9yLgpyYW5kb20uc2VlZCgpCgojCiMgQ29uc3RhbnRzCiMKCiMgdGhlc2UgdmFsdWVzIHdpbGwgYmUgcGF0Y2hlZCwgRE8gTk9UIENIQU5HRSBUSEVNCkRFQlVHR0lORyA9IEZhbHNlCkhUVFBfQ09OTkVDVElPTl9VUkwgPSBOb25lCkhUVFBfUFJPWFkgPSBOb25lCkhUVFBfVVNFUl9BR0VOVCA9IE5vbmUKUEFZTE9BRF9VVUlEID0gJzVjMjI1ZWUzYzU3YjZhM2JlN2UwZjJmNGIwNDg2MTMyJwpTRVNTSU9OX0NPTU1VTklDQVRJT05fVElNRU9VVCA9IDMwMApTRVNTSU9OX0VYUElSQVRJT05fVElNRU9VVCA9IDYwNDgwMApTRVNTSU9OX1JFVFJZX1RPVEFMID0gMzYwMApTRVNTSU9OX1JFVFJZX1dBSVQgPSAxMAoKUEFDS0VUX1RZUEVfUkVRVUVTVCAgICAgICAgPSAwClBBQ0tFVF9UWVBFX1JFU1BPTlNFICAgICAgID0gMQpQQUNLRVRfVFlQRV9QTEFJTl9SRVFVRVNUICA9IDEwClBBQ0tFVF9UWVBFX1BMQUlOX1JFU1BPTlNFID0gMTEKCkVSUk9SX1NVQ0NFU1MgPSAwCiMgbm90IGRlZmluZWQgaW4gb3JpZ2luYWwgQyBpbXBsZW1lbnRhdGlvbgpFUlJPUl9GQUlMVVJFID0gMQpFUlJPUl9GQUlMVVJFX1BZVEhPTiA9IDIKRVJST1JfRkFJTFVSRV9XSU5ET1dTID0gMwoKQ0hBTk5FTF9DTEFTU19CVUZGRVJFRCA9IDAKQ0hBTk5FTF9DTEFTU19TVFJFQU0gICA9IDEKQ0hBTk5FTF9DTEFTU19EQVRBR1JBTSA9IDIKQ0hBTk5FTF9DTEFTU19QT09MICAgICA9IDMKCiMKIyBUTFYgTWV0YSBUeXBlcwojClRMVl9NRVRBX1RZUEVfTk9ORSAgICAgICA9ICggICAwICAgKQpUTFZfTUVUQV9UWVBFX1NUUklORyAgICAgPSAoMSA8PCAxNikKVExWX01FVEFfVFlQRV9VSU5UICAgICAgID0gKDEgPDwgMTcpClRMVl9NRVRBX1RZUEVfUkFXICAgICAgICA9ICgxIDw8IDE4KQpUTFZfTUVUQV9UWVBFX0JPT0wgICAgICAgPSAoMSA8PCAxOSkKVExWX01FVEFfVFlQRV9RV09SRCAgICAgID0gKDEgPDwgMjApClRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRCA9ICgxIDw8IDI5KQpUTFZfTUVUQV9UWVBFX0dST1VQICAgICAgPSAoMSA8PCAzMCkKVExWX01FVEFfVFlQRV9DT01QTEVYICAgID0gKDEgPDwgMzEpCiMgbm90IGRlZmluZWQgaW4gb3JpZ2luYWwKVExWX01FVEFfVFlQRV9NQVNLID0gKDE8PDMxKSsoMTw8MzApKygxPDwyOSkrKDE8PDE5KSsoMTw8MTgpKygxPDwxNykrKDE8PDE2KQoKIwojIFRMViBiYXNlIHN0YXJ0aW5nIHBvaW50cwojClRMVl9SRVNFUlZFRCAgID0gMApUTFZfRVhURU5TSU9OUyA9IDIwMDAwClRMVl9VU0VSICAgICAgID0gNDAwMDAKVExWX1RFTVAgICAgICAgPSA2MDAwMAoKIwojIFRMViBTcGVjaWZpYyBUeXBlcwojClRMVl9UWVBFX0FOWSAgICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfTk9ORSAgICB8IDAKVExWX1RZUEVfTUVUSE9EICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgMQpUTFZfVFlQRV9SRVFVRVNUX0lEICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAyClRMVl9UWVBFX0VYQ0VQVElPTiAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfR1JPVVAgICB8IDMKVExWX1RZUEVfUkVTVUxUICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNAoKVExWX1RZUEVfU1RSSU5HICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgMTAKVExWX1RZUEVfVUlOVCAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMTEKVExWX1RZUEVfQk9PTCAgICAgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9CT09MICAgIHwgMTIKClRMVl9UWVBFX0xFTkdUSCAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDI1ClRMVl9UWVBFX0RBVEEgICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfUkFXICAgICB8IDI2ClRMVl9UWVBFX0ZMQUdTICAgICAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDI3CgpUTFZfVFlQRV9DSEFOTkVMX0lEICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1MApUTFZfVFlQRV9DSEFOTkVMX1RZUEUgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA1MQpUTFZfVFlQRV9DSEFOTkVMX0RBVEEgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA1MgpUTFZfVFlQRV9DSEFOTkVMX0RBVEFfR1JPVVAgICAgPSBUTFZfTUVUQV9UWVBFX0dST1VQICAgfCA1MwpUTFZfVFlQRV9DSEFOTkVMX0NMQVNTICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1NApUTFZfVFlQRV9DSEFOTkVMX1BBUkVOVElEICAgICAgPSBUTFZfTUVUQV9UWVBFX1VJTlQgICAgfCA1NQoKVExWX1RZUEVfU0VFS19XSEVOQ0UgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzAKVExWX1RZUEVfU0VFS19PRkZTRVQgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzEKVExWX1RZUEVfU0VFS19QT1MgICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNzIKClRMVl9UWVBFX0VYQ0VQVElPTl9DT0RFICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDMwMApUTFZfVFlQRV9FWENFUFRJT05fU1RSSU5HICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAzMDEKClRMVl9UWVBFX0xJQlJBUllfUEFUSCAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQwMApUTFZfVFlQRV9UQVJHRVRfUEFUSCAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MDEKVExWX1RZUEVfTUlHUkFURV9QSUQgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDAyClRMVl9UWVBFX01JR1JBVEVfTEVOICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQwMwoKVExWX1RZUEVfVFJBTlNfVFlQRSAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDMwClRMVl9UWVBFX1RSQU5TX1VSTCAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQzMQpUTFZfVFlQRV9UUkFOU19VQSAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzIKVExWX1RZUEVfVFJBTlNfQ09NTV9USU1FT1VUICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDMzClRMVl9UWVBFX1RSQU5TX1NFU1NJT05fRVhQICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQzNApUTFZfVFlQRV9UUkFOU19DRVJUX0hBU0ggICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA0MzUKVExWX1RZUEVfVFJBTlNfUFJPWFlfSE9TVCAgICAgID0gVExWX01FVEFfVFlQRV9TVFJJTkcgIHwgNDM2ClRMVl9UWVBFX1RSQU5TX1BST1hZX1VTRVIgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQzNwpUTFZfVFlQRV9UUkFOU19QUk9YWV9QQVNTICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCA0MzgKVExWX1RZUEVfVFJBTlNfUkVUUllfVE9UQUwgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgNDM5ClRMVl9UWVBFX1RSQU5TX1JFVFJZX1dBSVQgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDQ0MApUTFZfVFlQRV9UUkFOU19HUk9VUCAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX0dST1VQICAgfCA0NDEKClRMVl9UWVBFX01BQ0hJTkVfSUQgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDQ2MApUTFZfVFlQRV9VVUlEICAgICAgICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1JBVyAgICAgfCA0NjEKClRMVl9UWVBFX0NJUEhFUl9OQU1FICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDUwMApUTFZfVFlQRV9DSVBIRVJfUEFSQU1FVEVSUyAgICAgPSBUTFZfTUVUQV9UWVBFX0dST1VQICAgfCA1MDEKClRMVl9UWVBFX1BFRVJfSE9TVCAgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfU1RSSU5HICB8IDE1MDAKVExWX1RZUEVfUEVFUl9QT1JUICAgICAgICAgICAgID0gVExWX01FVEFfVFlQRV9VSU5UICAgIHwgMTUwMQpUTFZfVFlQRV9MT0NBTF9IT1NUICAgICAgICAgICAgPSBUTFZfTUVUQV9UWVBFX1NUUklORyAgfCAxNTAyClRMVl9UWVBFX0xPQ0FMX1BPUlQgICAgICAgICAgICA9IFRMVl9NRVRBX1RZUEVfVUlOVCAgICB8IDE1MDMKCkVYUE9SVEVEX1NZTUJPTFMgPSB7fQpFWFBPUlRFRF9TWU1CT0xTWydERUJVR0dJTkcnXSA9IERFQlVHR0lORwoKZGVmIHJhbmRfYnl0ZSgpOgoJcmV0dXJuIGNocihyYW5kb20ucmFuZGludCgxLCAyNTUpKQoKZGVmIHJhbmRfeG9yX2tleSgpOgoJcmV0dXJuICcnLmpvaW4ocmFuZF9ieXRlKCkgZm9yIF8gaW4gcmFuZ2UoNCkpCgpkZWYgeG9yX2J5dGVzKGtleSwgZGF0YSk6CglyZXR1cm4gJycuam9pbihjaHIob3JkKGRhdGFbaV0pIF4gb3JkKGtleVtpICUgbGVuKGtleSldKSkgZm9yIGkgaW4gcmFuZ2UobGVuKGRhdGEpKSkKCmRlZiBleHBvcnQoc3ltYm9sKToKCUVYUE9SVEVEX1NZTUJPTFNbc3ltYm9sLl9fbmFtZV9fXSA9IHN5bWJvbAoJcmV0dXJuIHN5bWJvbAoKZGVmIGdlbmVyYXRlX3JlcXVlc3RfaWQoKToKCWNoYXJzID0gJ2FiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6JwoJcmV0dXJuICcnLmpvaW4ocmFuZG9tLmNob2ljZShjaGFycykgZm9yIHggaW4gcmFuZ2UoMzIpKQoKQGV4cG9ydApkZWYgY3JjMTYoZGF0YSk6Cglwb2x5ID0gMHgxMDIxCglyZWcgPSAweDAwMDAKCWlmIGlzX3N0cihkYXRhKToKCQlkYXRhID0gbGlzdChtYXAob3JkLCBkYXRhKSkKCWVsaWYgaXNfYnl0ZXMoZGF0YSk6CgkJZGF0YSA9IGxpc3QoZGF0YSkKCWRhdGEuYXBwZW5kKDApCglkYXRhLmFwcGVuZCgwKQoJZm9yIGJ5dGUgaW4gZGF0YToKCQltYXNrID0gMHg4MAoJCXdoaWxlIG1hc2sgPiAwOgoJCQlyZWcgPDw9IDEKCQkJaWYgYnl0ZSAmIG1hc2s6CgkJCQlyZWcgKz0gMQoJCQltYXNrID4+PSAxCgkJCWlmIHJlZyA+IDB4ZmZmZjoKCQkJCXJlZyAmPSAweGZmZmYKCQkJCXJlZyBePSBwb2x5CglyZXR1cm4gcmVnCgpAZXhwb3J0CmRlZiBlcnJvcl9yZXN1bHQoZXhjZXB0aW9uPU5vbmUpOgoJaWYgbm90IGV4Y2VwdGlvbjoKCQlfLCBleGNlcHRpb24sIF8gPSBzeXMuZXhjX2luZm8oKQoJZXhjZXB0aW9uX2NyYyA9IGNyYzE2KGV4Y2VwdGlvbi5fX2NsYXNzX18uX19uYW1lX18pCglpZiBleGNlcHRpb25fY3JjID09IDB4NGNiMjogIyBXaW5kb3dzRXJyb3IKCQlyZXR1cm4gZXJyb3JfcmVzdWx0X3dpbmRvd3MoZXhjZXB0aW9uLmVycm5vKQoJZWxzZToKCQlyZXN1bHQgPSAoKGV4Y2VwdGlvbl9jcmMgPDwgMTYpIHwgRVJST1JfRkFJTFVSRV9QWVRIT04pCglyZXR1cm4gcmVzdWx0CgpAZXhwb3J0CmRlZiBlcnJvcl9yZXN1bHRfd2luZG93cyhlcnJvcl9udW1iZXI9Tm9uZSk6CglpZiBub3QgaGFzX3dpbmRsbDoKCQlyZXR1cm4gRVJST1JfRkFJTFVSRQoJaWYgZXJyb3JfbnVtYmVyID09IE5vbmU6CgkJZXJyb3JfbnVtYmVyID0gY3R5cGVzLndpbmRsbC5rZXJuZWwzMi5HZXRMYXN0RXJyb3IoKQoJaWYgZXJyb3JfbnVtYmVyID4gMHhmZmZmOgoJCXJldHVybiBFUlJPUl9GQUlMVVJFCglyZXN1bHQgPSAoKGVycm9yX251bWJlciA8PCAxNikgfCBFUlJPUl9GQUlMVVJFX1dJTkRPV1MpCglyZXR1cm4gcmVzdWx0CgpAZXhwb3J0CmRlZiBnZXRfaGRkX2xhYmVsKCk6Cglmb3IgXywgXywgZmlsZXMgaW4gb3Mud2FsaygnL2Rldi9kaXNrL2J5LWlkLycpOgoJCWZvciBmIGluIGZpbGVzOgoJCQlmb3IgcCBpbiBbJ2F0YS0nLCAnbWItJ106CgkJCQlpZiBmWzpsZW4ocCldID09IHA6CgkJCQkJcmV0dXJuIGZbbGVuKHApOl0KCXJldHVybiAnJwoKQGV4cG9ydApkZWYgaW5ldF9wdG9uKGZhbWlseSwgYWRkcmVzcyk6CglpZiBoYXNhdHRyKHNvY2tldCwgJ2luZXRfcHRvbicpOgoJCXJldHVybiBzb2NrZXQuaW5ldF9wdG9uKGZhbWlseSwgYWRkcmVzcykKCWVsaWYgaGFzX3dpbmRsbDoKCQlXU0FTdHJpbmdUb0FkZHJlc3MgPSBjdHlwZXMud2luZGxsLndzMl8zMi5XU0FTdHJpbmdUb0FkZHJlc3NBCgkJbHBBZGRyZXNzID0gKGN0eXBlcy5jX3VieXRlICogMjgpKCkKCQlscEFkZHJlc3NMZW5ndGggPSBjdHlwZXMuY19pbnQoY3R5cGVzLnNpemVvZihscEFkZHJlc3MpKQoJCWlmIFdTQVN0cmluZ1RvQWRkcmVzcyhhZGRyZXNzLCBmYW1pbHksIE5vbmUsIGN0eXBlcy5ieXJlZihscEFkZHJlc3MpLCBjdHlwZXMuYnlyZWYobHBBZGRyZXNzTGVuZ3RoKSkgIT0gMDoKCQkJcmFpc2UgRXhjZXB0aW9uKCdXU0FTdHJpbmdUb0FkZHJlc3MgZmFpbGVkJykKCQlpZiBmYW1pbHkgPT0gc29ja2V0LkFGX0lORVQ6CgkJCXJldHVybiAnJy5qb2luKG1hcChjaHIsIGxwQWRkcmVzc1s0OjhdKSkKCQllbGlmIGZhbWlseSA9PSBzb2NrZXQuQUZfSU5FVDY6CgkJCXJldHVybiAnJy5qb2luKG1hcChjaHIsIGxwQWRkcmVzc1s4OjI0XSkpCglyYWlzZSBFeGNlcHRpb24oJ25vIHN1aXRhYmxlIGluZXRfcHRvbiBmdW5jdGlvbmFsaXR5IGlzIGF2YWlsYWJsZScpCgpAZXhwb3J0CmRlZiBwYWNrZXRfZW51bV90bHZzKHBrdCwgdGx2X3R5cGUgPSBOb25lKToKCW9mZnNldCA9IDAKCXdoaWxlIChvZmZzZXQgPCBsZW4ocGt0KSk6CgkJdGx2ID0gc3RydWN0LnVucGFjaygnPklJJywgcGt0W29mZnNldDpvZmZzZXQrOF0pCgkJaWYgKHRsdl90eXBlID09IE5vbmUpIG9yICgodGx2WzFdICYgflRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRCkgPT0gdGx2X3R5cGUpOgoJCQl2YWwgPSBwa3Rbb2Zmc2V0Kzg6KG9mZnNldCs4Kyh0bHZbMF0gLSA4KSldCgkJCWlmICh0bHZbMV0gJiBUTFZfTUVUQV9UWVBFX1NUUklORykgPT0gVExWX01FVEFfVFlQRV9TVFJJTkc6CgkJCQl2YWwgPSBzdHIodmFsLnNwbGl0KE5VTExfQllURSwgMSlbMF0pCgkJCWVsaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfVUlOVCkgPT0gVExWX01FVEFfVFlQRV9VSU5UOgoJCQkJdmFsID0gc3RydWN0LnVucGFjaygnPkknLCB2YWwpWzBdCgkJCWVsaWYgKHRsdlsxXSAmIFRMVl9NRVRBX1RZUEVfUVdPUkQpID09IFRMVl9NRVRBX1RZUEVfUVdPUkQ6CgkJCQl2YWwgPSBzdHJ1Y3QudW5wYWNrKCc+UScsIHZhbClbMF0KCQkJZWxpZiAodGx2WzFdICYgVExWX01FVEFfVFlQRV9CT09MKSA9PSBUTFZfTUVUQV9UWVBFX0JPT0w6CgkJCQl2YWwgPSBib29sKHN0cnVjdC51bnBhY2soJ2InLCB2YWwpWzBdKQoJCQllbGlmICh0bHZbMV0gJiBUTFZfTUVUQV9UWVBFX1JBVykgPT0gVExWX01FVEFfVFlQRV9SQVc6CgkJCQlwYXNzCgkJCXlpZWxkIHsndHlwZSc6dGx2WzFdLCAnbGVuZ3RoJzp0bHZbMF0sICd2YWx1ZSc6dmFsfQoJCW9mZnNldCArPSB0bHZbMF0KCXJhaXNlIFN0b3BJdGVyYXRpb24oKQoKQGV4cG9ydApkZWYgcGFja2V0X2dldF90bHYocGt0LCB0bHZfdHlwZSk6Cgl0cnk6CgkJdGx2ID0gbGlzdChwYWNrZXRfZW51bV90bHZzKHBrdCwgdGx2X3R5cGUpKVswXQoJZXhjZXB0IEluZGV4RXJyb3I6CgkJcmV0dXJuIHt9CglyZXR1cm4gdGx2CgpAZXhwb3J0CmRlZiB0bHZfcGFjaygqYXJncyk6CglpZiBsZW4oYXJncykgPT0gMjoKCQl0bHYgPSB7J3R5cGUnOmFyZ3NbMF0sICd2YWx1ZSc6YXJnc1sxXX0KCWVsc2U6CgkJdGx2ID0gYXJnc1swXQoJZGF0YSA9ICcnCgl2YWx1ZSA9IHRsdlsndmFsdWUnXQoJaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9VSU5UKSA9PSBUTFZfTUVUQV9UWVBFX1VJTlQ6CgkJaWYgaXNpbnN0YW5jZSh2YWx1ZSwgZmxvYXQpOgoJCQl2YWx1ZSA9IGludChyb3VuZCh2YWx1ZSkpCgkJZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUlJJywgMTIsIHRsdlsndHlwZSddLCB2YWx1ZSkKCWVsaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9RV09SRCkgPT0gVExWX01FVEFfVFlQRV9RV09SRDoKCQlkYXRhID0gc3RydWN0LnBhY2soJz5JSVEnLCAxNiwgdGx2Wyd0eXBlJ10sIHZhbHVlKQoJZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0JPT0wpID09IFRMVl9NRVRBX1RZUEVfQk9PTDoKCQlkYXRhID0gc3RydWN0LnBhY2soJz5JSScsIDksIHRsdlsndHlwZSddKSArIGJ5dGVzKGNocihpbnQoYm9vbCh2YWx1ZSkpKSwgJ1VURi04JykKCWVsc2U6CgkJaWYgc3lzLnZlcnNpb25faW5mb1swXSA8IDMgYW5kIHZhbHVlLl9fY2xhc3NfXy5fX25hbWVfXyA9PSAndW5pY29kZSc6CgkJCXZhbHVlID0gdmFsdWUuZW5jb2RlKCdVVEYtOCcpCgkJZWxpZiBub3QgaXNfYnl0ZXModmFsdWUpOgoJCQl2YWx1ZSA9IGJ5dGVzKHZhbHVlLCAnVVRGLTgnKQoJCWlmICh0bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfU1RSSU5HKSA9PSBUTFZfTUVUQV9UWVBFX1NUUklORzoKCQkJZGF0YSA9IHN0cnVjdC5wYWNrKCc+SUknLCA4ICsgbGVuKHZhbHVlKSArIDEsIHRsdlsndHlwZSddKSArIHZhbHVlICsgTlVMTF9CWVRFCgkJZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX1JBVykgPT0gVExWX01FVEFfVFlQRV9SQVc6CgkJCWRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOCArIGxlbih2YWx1ZSksIHRsdlsndHlwZSddKSArIHZhbHVlCgkJZWxpZiAodGx2Wyd0eXBlJ10gJiBUTFZfTUVUQV9UWVBFX0dST1VQKSA9PSBUTFZfTUVUQV9UWVBFX0dST1VQOgoJCQlkYXRhID0gc3RydWN0LnBhY2soJz5JSScsIDggKyBsZW4odmFsdWUpLCB0bHZbJ3R5cGUnXSkgKyB2YWx1ZQoJCWVsaWYgKHRsdlsndHlwZSddICYgVExWX01FVEFfVFlQRV9DT01QTEVYKSA9PSBUTFZfTUVUQV9UWVBFX0NPTVBMRVg6CgkJCWRhdGEgPSBzdHJ1Y3QucGFjaygnPklJJywgOCArIGxlbih2YWx1ZSksIHRsdlsndHlwZSddKSArIHZhbHVlCglyZXR1cm4gZGF0YQoKQGV4cG9ydApkZWYgdGx2X3BhY2tfcmVzcG9uc2UocmVzdWx0LCByZXNwb25zZSk6CglyZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9SRVNVTFQsIHJlc3VsdCkKCXJlc3BvbnNlID0gc3RydWN0LnBhY2soJz5JJywgbGVuKHJlc3BvbnNlKSArIDQpICsgcmVzcG9uc2UKCXJldHVybiByZXNwb25zZQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJGaWxlKG9iamVjdCk6CglkZWYgX19pbml0X18oc2VsZiwgZmlsZV9vYmopOgoJCXNlbGYuZmlsZV9vYmogPSBmaWxlX29iagoKCWRlZiBfX2dldGF0dHJfXyhzZWxmLCBuYW1lKToKCQlyZXR1cm4gZ2V0YXR0cihzZWxmLmZpbGVfb2JqLCBuYW1lKQpleHBvcnQoTWV0ZXJwcmV0ZXJGaWxlKQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJTb2NrZXQob2JqZWN0KToKCWRlZiBfX2luaXRfXyhzZWxmLCBzb2NrKToKCQlzZWxmLnNvY2sgPSBzb2NrCgoJZGVmIF9fZ2V0YXR0cl9fKHNlbGYsIG5hbWUpOgoJCXJldHVybiBnZXRhdHRyKHNlbGYuc29jaywgbmFtZSkKZXhwb3J0KE1ldGVycHJldGVyU29ja2V0KQoKI0BleHBvcnQKY2xhc3MgTWV0ZXJwcmV0ZXJTb2NrZXRDbGllbnQoTWV0ZXJwcmV0ZXJTb2NrZXQpOgoJcGFzcwpleHBvcnQoTWV0ZXJwcmV0ZXJTb2NrZXRDbGllbnQpCgojQGV4cG9ydApjbGFzcyBNZXRlcnByZXRlclNvY2tldFNlcnZlcihNZXRlcnByZXRlclNvY2tldCk6CglwYXNzCmV4cG9ydChNZXRlcnByZXRlclNvY2tldFNlcnZlcikKCmNsYXNzIFNURFByb2Nlc3NCdWZmZXIodGhyZWFkaW5nLlRocmVhZCk6CglkZWYgX19pbml0X18oc2VsZiwgc3RkLCBpc19hbGl2ZSk6CgkJdGhyZWFkaW5nLlRocmVhZC5fX2luaXRfXyhzZWxmKQoJCXNlbGYuc3RkID0gc3RkCgkJc2VsZi5pc19hbGl2ZSA9IGlzX2FsaXZlCgkJc2VsZi5kYXRhID0gYnl0ZXMoKQoJCXNlbGYuZGF0YV9sb2NrID0gdGhyZWFkaW5nLlJMb2NrKCkKCglkZWYgcnVuKHNlbGYpOgoJCWZvciBieXRlIGluIGl0ZXIobGFtYmRhOiBzZWxmLnN0ZC5yZWFkKDEpLCBieXRlcygpKToKCQkJc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCgkJCXNlbGYuZGF0YSArPSBieXRlCgkJCXNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQoKCWRlZiBpc19yZWFkX3JlYWR5KHNlbGYpOgoJCXJldHVybiBsZW4oc2VsZi5kYXRhKSAhPSAwCgoJZGVmIHBlZWsoc2VsZiwgbCA9IE5vbmUpOgoJCWRhdGEgPSBieXRlcygpCgkJc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCgkJaWYgbCA9PSBOb25lOgoJCQlkYXRhID0gc2VsZi5kYXRhCgkJZWxzZToKCQkJZGF0YSA9IHNlbGYuZGF0YVswOmxdCgkJc2VsZi5kYXRhX2xvY2sucmVsZWFzZSgpCgkJcmV0dXJuIGRhdGEKCglkZWYgcmVhZChzZWxmLCBsID0gTm9uZSk6CgkJc2VsZi5kYXRhX2xvY2suYWNxdWlyZSgpCgkJZGF0YSA9IHNlbGYucGVlayhsKQoJCXNlbGYuZGF0YSA9IHNlbGYuZGF0YVtsZW4oZGF0YSk6XQoJCXNlbGYuZGF0YV9sb2NrLnJlbGVhc2UoKQoJCXJldHVybiBkYXRhCgojQGV4cG9ydApjbGFzcyBTVERQcm9jZXNzKHN1YnByb2Nlc3MuUG9wZW4pOgoJZGVmIF9faW5pdF9fKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CgkJc3VicHJvY2Vzcy5Qb3Blbi5fX2luaXRfXyhzZWxmLCAqYXJncywgKiprd2FyZ3MpCgkJc2VsZi5lY2hvX3Byb3RlY3Rpb24gPSBGYWxzZQoKCWRlZiBzdGFydChzZWxmKToKCQlzZWxmLnN0ZG91dF9yZWFkZXIgPSBTVERQcm9jZXNzQnVmZmVyKHNlbGYuc3Rkb3V0LCBsYW1iZGE6IHNlbGYucG9sbCgpID09IE5vbmUpCgkJc2VsZi5zdGRvdXRfcmVhZGVyLnN0YXJ0KCkKCQlzZWxmLnN0ZGVycl9yZWFkZXIgPSBTVERQcm9jZXNzQnVmZmVyKHNlbGYuc3RkZXJyLCBsYW1iZGE6IHNlbGYucG9sbCgpID09IE5vbmUpCgkJc2VsZi5zdGRlcnJfcmVhZGVyLnN0YXJ0KCkKCglkZWYgd3JpdGUoc2VsZiwgY2hhbm5lbF9kYXRhKToKCQlzZWxmLnN0ZGluLndyaXRlKGNoYW5uZWxfZGF0YSkKCQlzZWxmLnN0ZGluLmZsdXNoKCkKCQlpZiBzZWxmLmVjaG9fcHJvdGVjdGlvbjoKCQkJZW5kX3RpbWUgPSB0aW1lLnRpbWUoKSArIDAuNQoJCQlvdXRfZGF0YSA9IGJ5dGVzKCkKCQkJd2hpbGUgKHRpbWUudGltZSgpIDwgZW5kX3RpbWUpIGFuZCAob3V0X2RhdGEgIT0gY2hhbm5lbF9kYXRhKToKCQkJCWlmIHNlbGYuc3Rkb3V0X3JlYWRlci5pc19yZWFkX3JlYWR5KCk6CgkJCQkJb3V0X2RhdGEgPSBzZWxmLnN0ZG91dF9yZWFkZXIucGVlayhsZW4oY2hhbm5lbF9kYXRhKSkKCQkJaWYgb3V0X2RhdGEgPT0gY2hhbm5lbF9kYXRhOgoJCQkJc2VsZi5zdGRvdXRfcmVhZGVyLnJlYWQobGVuKGNoYW5uZWxfZGF0YSkpCmV4cG9ydChTVERQcm9jZXNzKQoKY2xhc3MgVHJhbnNwb3J0KG9iamVjdCk6CglkZWYgX19pbml0X18oc2VsZik6CgkJc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPSBTRVNTSU9OX0NPTU1VTklDQVRJT05fVElNRU9VVAoJCXNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ID0gMAoJCXNlbGYucmV0cnlfdG90YWwgPSBTRVNTSU9OX1JFVFJZX1RPVEFMCgkJc2VsZi5yZXRyeV93YWl0ID0gU0VTU0lPTl9SRVRSWV9XQUlUCgkJc2VsZi5yZXF1ZXN0X3JldGlyZSA9IEZhbHNlCgoJZGVmIF9fcmVwcl9fKHNlbGYpOgoJCXJldHVybiAiPHswfSB1cmw9J3sxfScgPiIuZm9ybWF0KHNlbGYuX19jbGFzc19fLl9fbmFtZV9fLCBzZWxmLnVybCkKCglAcHJvcGVydHkKCWRlZiBjb21tdW5pY2F0aW9uX2hhc19leHBpcmVkKHNlbGYpOgoJCXJldHVybiBzZWxmLmNvbW11bmljYXRpb25fbGFzdCArIHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0IDwgdGltZS50aW1lKCkKCglAcHJvcGVydHkKCWRlZiBzaG91bGRfcmV0aXJlKHNlbGYpOgoJCXJldHVybiBzZWxmLmNvbW11bmljYXRpb25faGFzX2V4cGlyZWQgb3Igc2VsZi5yZXF1ZXN0X3JldGlyZQoKCUBzdGF0aWNtZXRob2QKCWRlZiBmcm9tX3JlcXVlc3QocmVxdWVzdCk6CgkJdXJsID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfVVJMKVsndmFsdWUnXQoJCWlmIHVybC5zdGFydHN3aXRoKCd0Y3AnKToKCQkJdHJhbnNwb3J0ID0gVGNwVHJhbnNwb3J0KHVybCkKCQllbGlmIHVybC5zdGFydHN3aXRoKCdodHRwJyk6CgkJCXByb3h5ID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfUFJPWFlfSE9TVCkuZ2V0KCd2YWx1ZScpCgkJCXVzZXJfYWdlbnQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19VQSkuZ2V0KCd2YWx1ZScsIEhUVFBfVVNFUl9BR0VOVCkKCQkJdHJhbnNwb3J0ID0gSHR0cFRyYW5zcG9ydCh1cmwsIHByb3h5PXByb3h5LCB1c2VyX2FnZW50PXVzZXJfYWdlbnQpCgkJdHJhbnNwb3J0LmNvbW11bmljYXRpb25fdGltZW91dCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVCkuZ2V0KCd2YWx1ZScsIFNFU1NJT05fQ09NTVVOSUNBVElPTl9USU1FT1VUKQoJCXRyYW5zcG9ydC5yZXRyeV90b3RhbCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1JFVFJZX1RPVEFMKS5nZXQoJ3ZhbHVlJywgU0VTU0lPTl9SRVRSWV9UT1RBTCkKCQl0cmFuc3BvcnQucmV0cnlfd2FpdCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1JFVFJZX1dBSVQpLmdldCgndmFsdWUnLCBTRVNTSU9OX1JFVFJZX1dBSVQpCgkJcmV0dXJuIHRyYW5zcG9ydAoKCWRlZiBfYWN0aXZhdGUoc2VsZik6CgkJcmV0dXJuIFRydWUKCglkZWYgYWN0aXZhdGUoc2VsZik6CgkJZW5kX3RpbWUgPSB0aW1lLnRpbWUoKSArIHNlbGYucmV0cnlfdG90YWwKCQl3aGlsZSB0aW1lLnRpbWUoKSA8IGVuZF90aW1lOgoJCQl0cnk6CgkJCQlhY3RpdmF0ZV9zdWNjZWVkZWQgPSBzZWxmLl9hY3RpdmF0ZSgpCgkJCWV4Y2VwdDoKCQkJCWFjdGl2YXRlX3N1Y2NlZWRlZCA9IEZhbHNlCgkJCWlmIGFjdGl2YXRlX3N1Y2NlZWRlZDoKCQkJCXNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ID0gdGltZS50aW1lKCkKCQkJCXJldHVybiBUcnVlCgkJCXRpbWUuc2xlZXAoc2VsZi5yZXRyeV93YWl0KQoJCXJldHVybiBGYWxzZQoKCWRlZiBfZGVhY3RpdmF0ZShzZWxmKToKCQlyZXR1cm4KCglkZWYgZGVhY3RpdmF0ZShzZWxmKToKCQl0cnk6CgkJCXNlbGYuX2RlYWN0aXZhdGUoKQoJCWV4Y2VwdDoKCQkJcGFzcwoJCXNlbGYuY29tbXVuaWNhdGlvbl9sYXN0ID0gMAoJCXJldHVybiBUcnVlCgoJZGVmIGdldF9wYWNrZXQoc2VsZik6CgkJc2VsZi5yZXF1ZXN0X3JldGlyZSA9IEZhbHNlCgkJdHJ5OgoJCQlwa3QgPSBzZWxmLl9nZXRfcGFja2V0KCkKCQlleGNlcHQ6CgkJCXJldHVybiBOb25lCgkJaWYgcGt0IGlzIE5vbmU6CgkJCXJldHVybiBOb25lCgkJc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSB0aW1lLnRpbWUoKQoJCXJldHVybiBwa3QKCglkZWYgc2VuZF9wYWNrZXQoc2VsZiwgcGt0KToKCQlzZWxmLnJlcXVlc3RfcmV0aXJlID0gRmFsc2UKCQl0cnk6CgkJCXhvcl9rZXkgPSByYW5kX3hvcl9rZXkoKQoJCQlyYXcgPSB4b3Jfa2V5Wzo6LTFdICsgeG9yX2J5dGVzKHhvcl9rZXksIHBrdCkKCQkJc2VsZi5fc2VuZF9wYWNrZXQocmF3KQoJCWV4Y2VwdDoKCQkJcmV0dXJuIEZhbHNlCgkJc2VsZi5jb21tdW5pY2F0aW9uX2xhc3QgPSB0aW1lLnRpbWUoKQoJCXJldHVybiBUcnVlCgoJZGVmIHRsdl9wYWNrX3RpbWVvdXRzKHNlbGYpOgoJCXJlc3BvbnNlICA9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX0NPTU1fVElNRU9VVCwgc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCgkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfVE9UQUwsIHNlbGYucmV0cnlfdG90YWwpCgkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfUkVUUllfV0FJVCwgc2VsZi5yZXRyeV93YWl0KQoJCXJldHVybiByZXNwb25zZQoKCWRlZiB0bHZfcGFja190cmFuc3BvcnRfZ3JvdXAoc2VsZik6CgkJdHJhbnNfZ3JvdXAgID0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfVVJMLCBzZWxmLnVybCkKCQl0cmFuc19ncm91cCArPSBzZWxmLnRsdl9wYWNrX3RpbWVvdXRzKCkKCQlyZXR1cm4gdHJhbnNfZ3JvdXAKCmNsYXNzIEh0dHBUcmFuc3BvcnQoVHJhbnNwb3J0KToKCWRlZiBfX2luaXRfXyhzZWxmLCB1cmwsIHByb3h5PU5vbmUsIHVzZXJfYWdlbnQ9Tm9uZSk6CgkJc3VwZXIoSHR0cFRyYW5zcG9ydCwgc2VsZikuX19pbml0X18oKQoJCW9wZW5lcl9hcmdzID0gW10KCQlzY2hlbWUgPSB1cmwuc3BsaXQoJzonLCAxKVswXQoJCWlmIHNjaGVtZSA9PSAnaHR0cHMnIGFuZCAoKHN5cy52ZXJzaW9uX2luZm9bMF0gPT0gMiBhbmQgc3lzLnZlcnNpb25faW5mbyA+PSAoMiwgNywgOSkpIG9yIHN5cy52ZXJzaW9uX2luZm8gPj0gKDMsIDQsIDMpKToKCQkJaW1wb3J0IHNzbAoJCQlzc2xfY3R4ID0gc3NsLlNTTENvbnRleHQoc3NsLlBST1RPQ09MX1NTTHYyMykKCQkJc3NsX2N0eC5jaGVja19ob3N0bmFtZSA9IEZhbHNlCgkJCXNzbF9jdHgudmVyaWZ5X21vZGUgPSBzc2wuQ0VSVF9OT05FCgkJCW9wZW5lcl9hcmdzLmFwcGVuZCh1cmxsaWIuSFRUUFNIYW5kbGVyKDAsIHNzbF9jdHgpKQoJCWlmIHByb3h5OgoJCQlvcGVuZXJfYXJncy5hcHBlbmQodXJsbGliLlByb3h5SGFuZGxlcih7c2NoZW1lOiBwcm94eX0pKQoJCXNlbGYucHJveHkgPSBwcm94eQoJCW9wZW5lciA9IHVybGxpYi5idWlsZF9vcGVuZXIoKm9wZW5lcl9hcmdzKQoJCWlmIHVzZXJfYWdlbnQ6CgkJCW9wZW5lci5hZGRoZWFkZXJzID0gWygnVXNlci1BZ2VudCcsIHVzZXJfYWdlbnQpXQoJCXNlbGYudXNlcl9hZ2VudCA9IHVzZXJfYWdlbnQKCQl1cmxsaWIuaW5zdGFsbF9vcGVuZXIob3BlbmVyKQoJCXNlbGYudXJsID0gdXJsCgkJc2VsZi5faHR0cF9yZXF1ZXN0X2hlYWRlcnMgPSB7J0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nfQoJCXNlbGYuX2ZpcnN0X3BhY2tldCA9IE5vbmUKCQlzZWxmLl9lbXB0eV9jbnQgPSAwCgoJZGVmIF9hY3RpdmF0ZShzZWxmKToKCQlyZXR1cm4gVHJ1ZQoJCXNlbGYuX2ZpcnN0X3BhY2tldCA9IE5vbmUKCQlwYWNrZXQgPSBzZWxmLl9nZXRfcGFja2V0KCkKCQlpZiBwYWNrZXQgaXMgTm9uZToKCQkJcmV0dXJuIEZhbHNlCgkJc2VsZi5fZmlyc3RfcGFja2V0ID0gcGFja2V0CgkJcmV0dXJuIFRydWUKCglkZWYgX2dldF9wYWNrZXQoc2VsZik6CgkJaWYgc2VsZi5fZmlyc3RfcGFja2V0OgoJCQlwYWNrZXQgPSBzZWxmLl9maXJzdF9wYWNrZXQKCQkJc2VsZi5fZmlyc3RfcGFja2V0ID0gTm9uZQoJCQlyZXR1cm4gcGFja2V0CgkJcGFja2V0ID0gTm9uZQoJCXhvcl9rZXkgPSBOb25lCgkJcmVxdWVzdCA9IHVybGxpYi5SZXF1ZXN0KHNlbGYudXJsLCBOb25lLCBzZWxmLl9odHRwX3JlcXVlc3RfaGVhZGVycykKCQl1cmxfaCA9IHVybGxpYi51cmxvcGVuKHJlcXVlc3QsIHRpbWVvdXQ9c2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQpCgkJcGFja2V0ID0gdXJsX2gucmVhZCgpCgkJZm9yIF8gaW4gcmFuZ2UoMSk6CgkJCWlmIHBhY2tldCA9PSAnJzoKCQkJCWJyZWFrCgkJCWlmIGxlbihwYWNrZXQpIDwgMTI6CgkJCQlwYWNrZXQgPSBOb25lICAjIGxvb2tzIGNvcnJ1cHQKCQkJCWJyZWFrCgkJCXhvcl9rZXkgPSBwYWNrZXRbOjRdWzo6LTFdCgkJCWhlYWRlciA9IHhvcl9ieXRlcyh4b3Jfa2V5LCBwYWNrZXRbNDoxMl0pCgkJCXBrdF9sZW5ndGgsIF8gPSBzdHJ1Y3QudW5wYWNrKCc+SUknLCBoZWFkZXIpCgkJCWlmIGxlbihwYWNrZXQpIC0gNCAhPSBwa3RfbGVuZ3RoOgoJCQkJcGFja2V0ID0gTm9uZSAgIyBsb29rcyBjb3JydXB0CgkJaWYgbm90IHBhY2tldDoKCQkJZGVsYXkgPSAxMCAqIHNlbGYuX2VtcHR5X2NudAoJCQlpZiBzZWxmLl9lbXB0eV9jbnQgPj0gMDoKCQkJCWRlbGF5ICo9IDEwCgkJCXNlbGYuX2VtcHR5X2NudCArPSAxCgkJCXRpbWUuc2xlZXAoZmxvYXQobWluKDEwMDAwLCBkZWxheSkpIC8gMTAwMCkKCQkJcmV0dXJuIHBhY2tldAoJCXNlbGYuX2VtcHR5X2NudCA9IDAKCQlyZXR1cm4geG9yX2J5dGVzKHhvcl9rZXksIHBhY2tldFsxMjpdKQoKCWRlZiBfc2VuZF9wYWNrZXQoc2VsZiwgcGFja2V0KToKCQlyZXF1ZXN0ID0gdXJsbGliLlJlcXVlc3Qoc2VsZi51cmwsIHBhY2tldCwgc2VsZi5faHR0cF9yZXF1ZXN0X2hlYWRlcnMpCgkJdXJsX2ggPSB1cmxsaWIudXJsb3BlbihyZXF1ZXN0LCB0aW1lb3V0PXNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0KQoJCXJlc3BvbnNlID0gdXJsX2gucmVhZCgpCgoJZGVmIHBhdGNoX3VyaV9wYXRoKHNlbGYsIG5ld19wYXRoKToKCQltYXRjaCA9IHJlLm1hdGNoKHInaHR0cHM/Oi8vW14vXSsoLy4qJCknLCBzZWxmLnVybCkKCQlpZiBtYXRjaCBpcyBOb25lOgoJCQlyZXR1cm4gRmFsc2UKCQlzZWxmLnVybCA9IHNlbGYudXJsWzptYXRjaC5zcGFuKDEpWzBdXSArIG5ld19wYXRoCgkJcmV0dXJuIFRydWUKCglkZWYgdGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKHNlbGYpOgoJCXRyYW5zX2dyb3VwICA9IHN1cGVyKEh0dHBUcmFuc3BvcnQsIHNlbGYpLnRsdl9wYWNrX3RyYW5zcG9ydF9ncm91cCgpCgkJaWYgc2VsZi51c2VyX2FnZW50OgoJCQl0cmFuc19ncm91cCArPSB0bHZfcGFjayhUTFZfVFlQRV9UUkFOU19VQSwgc2VsZi51c2VyX2FnZW50KQoJCWlmIHNlbGYucHJveHk6CgkJCXRyYW5zX2dyb3VwICs9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX1BST1hZX0hPU1QsIHNlbGYucHJveHkpCgkJcmV0dXJuIHRyYW5zX2dyb3VwCgpjbGFzcyBUY3BUcmFuc3BvcnQoVHJhbnNwb3J0KToKCWRlZiBfX2luaXRfXyhzZWxmLCB1cmwsIHNvY2tldD1Ob25lKToKCQlzdXBlcihUY3BUcmFuc3BvcnQsIHNlbGYpLl9faW5pdF9fKCkKCQlzZWxmLnVybCA9IHVybAoJCXNlbGYuc29ja2V0ID0gc29ja2V0CgkJc2VsZi5fY2xlYW51cF90aHJlYWQgPSBOb25lCgkJc2VsZi5fZmlyc3RfcGFja2V0ID0gVHJ1ZQoKCWRlZiBfc29ja19jbGVhbnVwKHNlbGYsIHNvY2spOgoJCXJlbWFpbmluZ190aW1lID0gc2VsZi5jb21tdW5pY2F0aW9uX3RpbWVvdXQKCQl3aGlsZSByZW1haW5pbmdfdGltZSA+IDA6CgkJCWl0ZXJfc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCgkJCWlmIHNlbGVjdC5zZWxlY3QoW3NvY2tdLCBbXSwgW10sIHJlbWFpbmluZ190aW1lKVswXToKCQkJCWlmIGxlbihzb2NrLnJlY3YoNDA5NikpID09IDA6CgkJCQkJYnJlYWsKCQkJcmVtYWluaW5nX3RpbWUgLT0gdGltZS50aW1lKCkgLSBpdGVyX3N0YXJ0X3RpbWUKCQlzb2NrLmNsb3NlKCkKCglkZWYgX2FjdGl2YXRlKHNlbGYpOgoJCWFkZHJlc3MsIHBvcnQgPSBzZWxmLnVybFs2Ol0ucnNwbGl0KCc6JywgMSkKCQlwb3J0ID0gaW50KHBvcnQucnN0cmlwKCcvJykpCgkJdGltZW91dCA9IG1heChzZWxmLmNvbW11bmljYXRpb25fdGltZW91dCwgMzApCgkJaWYgYWRkcmVzcyBpbiAoJycsICcwLjAuMC4wJywgJzo6Jyk6CgkJCXRyeToKCQkJCXNlcnZlcl9zb2NrID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVDYsIHNvY2tldC5TT0NLX1NUUkVBTSkKCQkJCXNlcnZlcl9zb2NrLnNldHNvY2tvcHQoc29ja2V0LklQUFJPVE9fSVBWNiwgc29ja2V0LklQVjZfVjZPTkxZLCAwKQoJCQlleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBzb2NrZXQuZXJyb3IpOgoJCQkJc2VydmVyX3NvY2sgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULCBzb2NrZXQuU09DS19TVFJFQU0pCgkJCXNlcnZlcl9zb2NrLmJpbmQoKCcnLCBwb3J0KSkKCQkJc2VydmVyX3NvY2subGlzdGVuKDEpCgkJCWlmIG5vdCBzZWxlY3Quc2VsZWN0KFtzZXJ2ZXJfc29ja10sIFtdLCBbXSwgdGltZW91dClbMF06CgkJCQlzZXJ2ZXJfc29jay5jbG9zZSgpCgkJCQlyZXR1cm4gRmFsc2UKCQkJc29jaywgXyA9IHNlcnZlcl9zb2NrLmFjY2VwdCgpCgkJCXNlcnZlcl9zb2NrLmNsb3NlKCkKCQllbHNlOgoJCQlpZiAnOicgaW4gYWRkcmVzczoKCQkJCXNvY2sgPSBzb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVUNiwgc29ja2V0LlNPQ0tfU1RSRUFNKQoJCQllbHNlOgoJCQkJc29jayA9IHNvY2tldC5zb2NrZXQoc29ja2V0LkFGX0lORVQsIHNvY2tldC5TT0NLX1NUUkVBTSkKCQkJc29jay5zZXR0aW1lb3V0KHRpbWVvdXQpCgkJCXNvY2suY29ubmVjdCgoYWRkcmVzcywgcG9ydCkpCgkJCXNvY2suc2V0dGltZW91dChOb25lKQoJCXNlbGYuc29ja2V0ID0gc29jawoJCXNlbGYuX2ZpcnN0X3BhY2tldCA9IFRydWUKCQlyZXR1cm4gVHJ1ZQoKCWRlZiBfZGVhY3RpdmF0ZShzZWxmKToKCQljbGVhbnVwID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5fc29ja19jbGVhbnVwLCBhcmdzPShzZWxmLnNvY2tldCwpKQoJCWNsZWFudXAucnVuKCkKCQlzZWxmLnNvY2tldCA9IE5vbmUKCglkZWYgX2dldF9wYWNrZXQoc2VsZik6CgkJZmlyc3QgPSBzZWxmLl9maXJzdF9wYWNrZXQKCQlzZWxmLl9maXJzdF9wYWNrZXQgPSBGYWxzZQoJCWlmIG5vdCBzZWxlY3Quc2VsZWN0KFtzZWxmLnNvY2tldF0sIFtdLCBbXSwgMC41KVswXToKCQkJcmV0dXJuICcnCgkJcGFja2V0ID0gc2VsZi5zb2NrZXQucmVjdigxMikKCQlpZiBwYWNrZXQgPT0gJyc6ICAjIHJlbW90ZSBpcyBjbG9zZWQKCQkJc2VsZi5yZXF1ZXN0X3JldGlyZSA9IFRydWUKCQkJcmV0dXJuIE5vbmUKCQlpZiBsZW4ocGFja2V0KSAhPSAxMjoKCQkJaWYgZmlyc3QgYW5kIGxlbihwYWNrZXQpID09IDQ6CgkJCQlyZWNlaXZlZCA9IDAKCQkJCWhlYWRlciA9IHBhY2tldFs6NF0KCQkJCXBrdF9sZW5ndGggPSBzdHJ1Y3QudW5wYWNrKCc+SScsIGhlYWRlcilbMF0KCQkJCXNlbGYuc29ja2V0LnNldHRpbWVvdXQobWF4KHNlbGYuY29tbXVuaWNhdGlvbl90aW1lb3V0LCAzMCkpCgkJCQl3aGlsZSByZWNlaXZlZCA8IHBrdF9sZW5ndGg6CgkJCQkJcmVjZWl2ZWQgKz0gbGVuKHNlbGYuc29ja2V0LnJlY3YocGt0X2xlbmd0aCAtIHJlY2VpdmVkKSkKCQkJCXNlbGYuc29ja2V0LnNldHRpbWVvdXQoTm9uZSkKCQkJCXJldHVybiBzZWxmLl9nZXRfcGFja2V0KCkKCQkJcmV0dXJuIE5vbmUKCgkJeG9yX2tleSA9IHBhY2tldFs6NF1bOjotMV0KCQloZWFkZXIgPSB4b3JfYnl0ZXMoeG9yX2tleSwgcGFja2V0WzQ6MTJdKQoJCXBrdF9sZW5ndGgsIHBrdF90eXBlID0gc3RydWN0LnVucGFjaygnPklJJywgaGVhZGVyKQoJCXBrdF9sZW5ndGggLT0gOAoJCXBhY2tldCA9IGJ5dGVzKCkKCQl3aGlsZSBsZW4ocGFja2V0KSA8IHBrdF9sZW5ndGg6CgkJCXBhY2tldCArPSBzZWxmLnNvY2tldC5yZWN2KHBrdF9sZW5ndGggLSBsZW4ocGFja2V0KSkKCQlyZXR1cm4geG9yX2J5dGVzKHhvcl9rZXksIHBhY2tldCkKCglkZWYgX3NlbmRfcGFja2V0KHNlbGYsIHBhY2tldCk6CgkJc2VsZi5zb2NrZXQuc2VuZChwYWNrZXQpCgoJQGNsYXNzbWV0aG9kCglkZWYgZnJvbV9zb2NrZXQoY2xzLCBzb2NrKToKCQl1cmwgPSAndGNwOi8vJwoJCWFkZHJlc3MsIHBvcnQgPSBzb2NrLmdldHNvY2tuYW1lKClbOjJdCgkJIyB0aGlzIHdpbGwgbmVlZCB0byBiZSBjaGFuZ2VkIGlmIHRoZSBiaW5kIHN0YWdlciBldmVyIHN1cHBvcnRzIGJpbmRpbmcgdG8gYSBzcGVjaWZpYyBhZGRyZXNzCgkJaWYgbm90IGFkZHJlc3MgaW4gKCcnLCAnMC4wLjAuMCcsICc6OicpOgoJCQlhZGRyZXNzLCBwb3J0ID0gc29jay5nZXRwZWVybmFtZSgpWzoyXQoJCXVybCArPSBhZGRyZXNzICsgJzonICsgc3RyKHBvcnQpCgkJcmV0dXJuIGNscyh1cmwsIHNvY2spCgpjbGFzcyBQeXRob25NZXRlcnByZXRlcihvYmplY3QpOgoJZGVmIF9faW5pdF9fKHNlbGYsIHRyYW5zcG9ydCk6CgkJc2VsZi50cmFuc3BvcnQgPSB0cmFuc3BvcnQKCQlzZWxmLnJ1bm5pbmcgPSBGYWxzZQoJCXNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IE5vbmUKCQlzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnMgPSB7fQoJCXNlbGYuY2hhbm5lbHMgPSB7fQoJCXNlbGYubmV4dF9jaGFubmVsX2lkID0gMQoJCXNlbGYuaW50ZXJhY3RfY2hhbm5lbHMgPSBbXQoJCXNlbGYucHJvY2Vzc2VzID0ge30KCQlzZWxmLm5leHRfcHJvY2Vzc19pZCA9IDEKCQlzZWxmLnRyYW5zcG9ydHMgPSBbc2VsZi50cmFuc3BvcnRdCgkJc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lID0gU0VTU0lPTl9FWFBJUkFUSU9OX1RJTUVPVVQKCQlzZWxmLnNlc3Npb25fZXhwaXJ5X2VuZCA9IHRpbWUudGltZSgpICsgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lCgkJZm9yIGZ1bmMgaW4gbGlzdChmaWx0ZXIobGFtYmRhIHg6IHguc3RhcnRzd2l0aCgnX2NvcmUnKSwgZGlyKHNlbGYpKSk6CgkJCXNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uc1tmdW5jWzE6XV0gPSBnZXRhdHRyKHNlbGYsIGZ1bmMpCgkJc2VsZi5ydW5uaW5nID0gVHJ1ZQoKCWRlZiBkZWJ1Z19wcmludChzZWxmLCBtc2cpOgoJCWlmIERFQlVHR0lORzoKCQkJcHJpbnQobXNnKQoKCWRlZiByZWdpc3Rlcl9leHRlbnNpb24oc2VsZiwgZXh0ZW5zaW9uX25hbWUpOgoJCXNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbiA9IGV4dGVuc2lvbl9uYW1lCgkJcmV0dXJuIHNlbGYubGFzdF9yZWdpc3RlcmVkX2V4dGVuc2lvbgoKCWRlZiByZWdpc3Rlcl9mdW5jdGlvbihzZWxmLCBmdW5jKToKCQlzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnNbZnVuYy5fX25hbWVfX10gPSBmdW5jCgkJcmV0dXJuIGZ1bmMKCglkZWYgcmVnaXN0ZXJfZnVuY3Rpb25fd2luZGxsKHNlbGYsIGZ1bmMpOgoJCWlmIGhhc193aW5kbGw6CgkJCXNlbGYucmVnaXN0ZXJfZnVuY3Rpb24oZnVuYykKCQlyZXR1cm4gZnVuYwoKCWRlZiBhZGRfY2hhbm5lbChzZWxmLCBjaGFubmVsKToKCQlhc3NlcnQoaXNpbnN0YW5jZShjaGFubmVsLCAoc3VicHJvY2Vzcy5Qb3BlbiwgTWV0ZXJwcmV0ZXJGaWxlLCBNZXRlcnByZXRlclNvY2tldCkpKQoJCWlkeCA9IHNlbGYubmV4dF9jaGFubmVsX2lkCgkJc2VsZi5jaGFubmVsc1tpZHhdID0gY2hhbm5lbAoJCXNlbGYuZGVidWdfcHJpbnQoJ1sqXSBhZGRlZCBjaGFubmVsIGlkOiAnICsgc3RyKGlkeCkgKyAnIHR5cGU6ICcgKyBjaGFubmVsLl9fY2xhc3NfXy5fX25hbWVfXykKCQlzZWxmLm5leHRfY2hhbm5lbF9pZCArPSAxCgkJcmV0dXJuIGlkeAoKCWRlZiBhZGRfcHJvY2VzcyhzZWxmLCBwcm9jZXNzKToKCQlpZHggPSBzZWxmLm5leHRfcHJvY2Vzc19pZAoJCXNlbGYucHJvY2Vzc2VzW2lkeF0gPSBwcm9jZXNzCgkJc2VsZi5kZWJ1Z19wcmludCgnWypdIGFkZGVkIHByb2Nlc3MgaWQ6ICcgKyBzdHIoaWR4KSkKCQlzZWxmLm5leHRfcHJvY2Vzc19pZCArPSAxCgkJcmV0dXJuIGlkeAoKCWRlZiBnZXRfcGFja2V0KHNlbGYpOgoJCXBrdCA9IHNlbGYudHJhbnNwb3J0LmdldF9wYWNrZXQoKQoJCWlmIHBrdCBpcyBOb25lIGFuZCBzZWxmLnRyYW5zcG9ydC5zaG91bGRfcmV0aXJlOgoJCQlzZWxmLnRyYW5zcG9ydF9jaGFuZ2UoKQoJCXJldHVybiBwa3QKCglkZWYgc2VuZF9wYWNrZXQoc2VsZiwgcGFja2V0KToKCQlzZW5kX3N1Y2NlZWRlZCA9IHNlbGYudHJhbnNwb3J0LnNlbmRfcGFja2V0KHBhY2tldCkKCQlpZiBub3Qgc2VuZF9zdWNjZWVkZWQgYW5kIHNlbGYudHJhbnNwb3J0LnNob3VsZF9yZXRpcmU6CgkJCXNlbGYudHJhbnNwb3J0X2NoYW5nZSgpCgkJcmV0dXJuIHNlbmRfc3VjY2VlZGVkCgoJQHByb3BlcnR5CglkZWYgc2Vzc2lvbl9oYXNfZXhwaXJlZChzZWxmKToKCQlpZiBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPT0gMDoKCQkJcmV0dXJuIEZhbHNlCgkJcmV0dXJuIHRpbWUudGltZSgpID4gc2VsZi5zZXNzaW9uX2V4cGlyeV9lbmQKCglkZWYgdHJhbnNwb3J0X2FkZChzZWxmLCBuZXdfdHJhbnNwb3J0KToKCQluZXdfcG9zaXRpb24gPSBzZWxmLnRyYW5zcG9ydHMuaW5kZXgoc2VsZi50cmFuc3BvcnQpCgkJc2VsZi50cmFuc3BvcnRzLmluc2VydChuZXdfcG9zaXRpb24sIG5ld190cmFuc3BvcnQpCgoJZGVmIHRyYW5zcG9ydF9jaGFuZ2Uoc2VsZiwgbmV3X3RyYW5zcG9ydD1Ob25lKToKCQlpZiBuZXdfdHJhbnNwb3J0IGlzIE5vbmU6CgkJCW5ld190cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydF9uZXh0KCkKCQlzZWxmLnRyYW5zcG9ydC5kZWFjdGl2YXRlKCkKCQlzZWxmLmRlYnVnX3ByaW50KCdbKl0gY2hhbmdpbmcgdHJhbnNwb3J0IHRvOiAnICsgbmV3X3RyYW5zcG9ydC51cmwpCgkJd2hpbGUgbm90IG5ld190cmFuc3BvcnQuYWN0aXZhdGUoKToKCQkJbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQobmV3X3RyYW5zcG9ydCkKCQkJc2VsZi5kZWJ1Z19wcmludCgnWypdIGNoYW5naW5nIHRyYW5zcG9ydCB0bzogJyArIG5ld190cmFuc3BvcnQudXJsKQoJCXNlbGYudHJhbnNwb3J0ID0gbmV3X3RyYW5zcG9ydAoKCWRlZiB0cmFuc3BvcnRfbmV4dChzZWxmLCBjdXJyZW50X3RyYW5zcG9ydD1Ob25lKToKCQlpZiBjdXJyZW50X3RyYW5zcG9ydCBpcyBOb25lOgoJCQljdXJyZW50X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0CgkJbmV3X2lkeCA9IHNlbGYudHJhbnNwb3J0cy5pbmRleChjdXJyZW50X3RyYW5zcG9ydCkgKyAxCgkJaWYgbmV3X2lkeCA9PSBsZW4oc2VsZi50cmFuc3BvcnRzKToKCQkJbmV3X2lkeCA9IDAKCQlyZXR1cm4gc2VsZi50cmFuc3BvcnRzW25ld19pZHhdCgoJZGVmIHRyYW5zcG9ydF9wcmV2KHNlbGYsIGN1cnJlbnRfdHJhbnNwb3J0PU5vbmUpOgoJCWlmIGN1cnJlbnRfdHJhbnNwb3J0IGlzIE5vbmU6CgkJCWN1cnJlbnRfdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnQKCQluZXdfaWR4ID0gc2VsZi50cmFuc3BvcnRzLmluZGV4KGN1cnJlbnRfdHJhbnNwb3J0KSAtIDEKCQlpZiBuZXdfaWR4ID09IC0xOgoJCQluZXdfaWR4ID0gbGVuKHNlbGYudHJhbnNwb3J0cykgLSAxCgkJcmV0dXJuIHNlbGYudHJhbnNwb3J0c1tuZXdfaWR4XQoKCWRlZiBydW4oc2VsZik6CgkJd2hpbGUgc2VsZi5ydW5uaW5nIGFuZCBub3Qgc2VsZi5zZXNzaW9uX2hhc19leHBpcmVkOgoJCQlyZXF1ZXN0ID0gc2VsZi5nZXRfcGFja2V0KCkKCQkJaWYgcmVxdWVzdDoKCQkJCXJlc3BvbnNlID0gc2VsZi5jcmVhdGVfcmVzcG9uc2UocmVxdWVzdCkKCQkJCWlmIHJlc3BvbnNlOgoJCQkJCXNlbGYuc2VuZF9wYWNrZXQocmVzcG9uc2UpCgkJCQljb250aW51ZQoJCQkjIGl0ZXJhdGUgb3ZlciB0aGUga2V5cyBiZWNhdXNlIHNlbGYuY2hhbm5lbHMgY291bGQgYmUgbW9kaWZpZWQgaWYgb25lIGlzIGNsb3NlZAoJCQljaGFubmVsX2lkcyA9IGxpc3Qoc2VsZi5jaGFubmVscy5rZXlzKCkpCgkJCWZvciBjaGFubmVsX2lkIGluIGNoYW5uZWxfaWRzOgoJCQkJY2hhbm5lbCA9IHNlbGYuY2hhbm5lbHNbY2hhbm5lbF9pZF0KCQkJCWRhdGEgPSBieXRlcygpCgkJCQlpZiBpc2luc3RhbmNlKGNoYW5uZWwsIFNURFByb2Nlc3MpOgoJCQkJCWlmIG5vdCBjaGFubmVsX2lkIGluIHNlbGYuaW50ZXJhY3RfY2hhbm5lbHM6CgkJCQkJCWNvbnRpbnVlCgkJCQkJaWYgY2hhbm5lbC5zdGRlcnJfcmVhZGVyLmlzX3JlYWRfcmVhZHkoKToKCQkJCQkJZGF0YSA9IGNoYW5uZWwuc3RkZXJyX3JlYWRlci5yZWFkKCkKCQkJCQllbGlmIGNoYW5uZWwuc3Rkb3V0X3JlYWRlci5pc19yZWFkX3JlYWR5KCk6CgkJCQkJCWRhdGEgPSBjaGFubmVsLnN0ZG91dF9yZWFkZXIucmVhZCgpCgkJCQkJZWxpZiBjaGFubmVsLnBvbGwoKSAhPSBOb25lOgoJCQkJCQlzZWxmLmhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoY2hhbm5lbF9pZCkKCQkJCWVsaWYgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlclNvY2tldENsaWVudCk6CgkJCQkJd2hpbGUgc2VsZWN0LnNlbGVjdChbY2hhbm5lbC5maWxlbm8oKV0sIFtdLCBbXSwgMClbMF06CgkJCQkJCXRyeToKCQkJCQkJCWQgPSBjaGFubmVsLnJlY3YoMSkKCQkJCQkJZXhjZXB0IHNvY2tldC5lcnJvcjoKCQkJCQkJCWQgPSBieXRlcygpCgkJCQkJCWlmIGxlbihkKSA9PSAwOgoJCQkJCQkJc2VsZi5oYW5kbGVfZGVhZF9yZXNvdXJjZV9jaGFubmVsKGNoYW5uZWxfaWQpCgkJCQkJCQlicmVhawoJCQkJCQlkYXRhICs9IGQKCQkJCWVsaWYgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlclNvY2tldFNlcnZlcik6CgkJCQkJaWYgc2VsZWN0LnNlbGVjdChbY2hhbm5lbC5maWxlbm8oKV0sIFtdLCBbXSwgMClbMF06CgkJCQkJCShjbGllbnRfc29jaywgY2xpZW50X2FkZHIpID0gY2hhbm5lbC5hY2NlcHQoKQoJCQkJCQlzZXJ2ZXJfYWRkciA9IGNoYW5uZWwuZ2V0c29ja25hbWUoKQoJCQkJCQljbGllbnRfY2hhbm5lbF9pZCA9IHNlbGYuYWRkX2NoYW5uZWwoTWV0ZXJwcmV0ZXJTb2NrZXRDbGllbnQoY2xpZW50X3NvY2spKQoJCQkJCQlwa3QgID0gc3RydWN0LnBhY2soJz5JJywgUEFDS0VUX1RZUEVfUkVRVUVTVCkKCQkJCQkJcGt0ICs9IHRsdl9wYWNrKFRMVl9UWVBFX01FVEhPRCwgJ3RjcF9jaGFubmVsX29wZW4nKQoJCQkJCQlwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfQ0hBTk5FTF9JRCwgY2xpZW50X2NoYW5uZWxfaWQpCgkJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9DSEFOTkVMX1BBUkVOVElELCBjaGFubmVsX2lkKQoJCQkJCQlwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfTE9DQUxfSE9TVCwgaW5ldF9wdG9uKGNoYW5uZWwuZmFtaWx5LCBzZXJ2ZXJfYWRkclswXSkpCgkJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9MT0NBTF9QT1JULCBzZXJ2ZXJfYWRkclsxXSkKCQkJCQkJcGt0ICs9IHRsdl9wYWNrKFRMVl9UWVBFX1BFRVJfSE9TVCwgaW5ldF9wdG9uKGNsaWVudF9zb2NrLmZhbWlseSwgY2xpZW50X2FkZHJbMF0pKQoJCQkJCQlwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfUEVFUl9QT1JULCBjbGllbnRfYWRkclsxXSkKCQkJCQkJcGt0ICA9IHN0cnVjdC5wYWNrKCc+SScsIGxlbihwa3QpICsgNCkgKyBwa3QKCQkJCQkJc2VsZi5zZW5kX3BhY2tldChwa3QpCgkJCQlpZiBkYXRhOgoJCQkJCXBrdCAgPSBzdHJ1Y3QucGFjaygnPkknLCBQQUNLRVRfVFlQRV9SRVFVRVNUKQoJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9NRVRIT0QsICdjb3JlX2NoYW5uZWxfd3JpdGUnKQoJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9DSEFOTkVMX0lELCBjaGFubmVsX2lkKQoJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9DSEFOTkVMX0RBVEEsIGRhdGEpCgkJCQkJcGt0ICs9IHRsdl9wYWNrKFRMVl9UWVBFX0xFTkdUSCwgbGVuKGRhdGEpKQoJCQkJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9SRVFVRVNUX0lELCBnZW5lcmF0ZV9yZXF1ZXN0X2lkKCkpCgkJCQkJcGt0ICA9IHN0cnVjdC5wYWNrKCc+SScsIGxlbihwa3QpICsgNCkgKyBwa3QKCQkJCQlzZWxmLnNlbmRfcGFja2V0KHBrdCkKCglkZWYgaGFuZGxlX2RlYWRfcmVzb3VyY2VfY2hhbm5lbChzZWxmLCBjaGFubmVsX2lkKToKCQlkZWwgc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQoJCWlmIGNoYW5uZWxfaWQgaW4gc2VsZi5pbnRlcmFjdF9jaGFubmVsczoKCQkJc2VsZi5pbnRlcmFjdF9jaGFubmVscy5yZW1vdmUoY2hhbm5lbF9pZCkKCQlwa3QgID0gc3RydWN0LnBhY2soJz5JJywgUEFDS0VUX1RZUEVfUkVRVUVTVCkKCQlwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfTUVUSE9ELCAnY29yZV9jaGFubmVsX2Nsb3NlJykKCQlwa3QgKz0gdGx2X3BhY2soVExWX1RZUEVfUkVRVUVTVF9JRCwgZ2VuZXJhdGVfcmVxdWVzdF9pZCgpKQoJCXBrdCArPSB0bHZfcGFjayhUTFZfVFlQRV9DSEFOTkVMX0lELCBjaGFubmVsX2lkKQoJCXBrdCAgPSBzdHJ1Y3QucGFjaygnPkknLCBsZW4ocGt0KSArIDQpICsgcGt0CgkJc2VsZi5zZW5kX3BhY2tldChwa3QpCgoJZGVmIF9jb3JlX3V1aWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCXJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1VVSUQsIGJpbmFzY2lpLmEyYl9oZXgoUEFZTE9BRF9VVUlEKSkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfZW51bWV4dGNtZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJZXh0ZW5zaW9uX25hbWUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9TVFJJTkcpWyd2YWx1ZSddCgkJZm9yIGZ1bmNfbmFtZSBpbiBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnMua2V5cygpOgoJCQlpZiBmdW5jX25hbWUuc3BsaXQoJ18nLCAxKVswXSA9PSBleHRlbnNpb25fbmFtZToKCQkJCXJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1NUUklORywgZnVuY19uYW1lKQoJCXJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCWRlZiBfY29yZV9tYWNoaW5lX2lkKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKCQlzZXJpYWwgPSAnJwoJCW1hY2hpbmVfbmFtZSA9IHBsYXRmb3JtLnVuYW1lKClbMV0KCQlpZiBoYXNfd2luZGxsOgoJCQlmcm9tIGN0eXBlcyBpbXBvcnQgd2ludHlwZXMKCgkJCWszMiA9IGN0eXBlcy53aW5kbGwua2VybmVsMzIKCQkJc3lzX2RpciA9IGN0eXBlcy5jcmVhdGVfdW5pY29kZV9idWZmZXIoMjYwKQoJCQlpZiBub3QgazMyLkdldFN5c3RlbURpcmVjdG9yeVcoY3R5cGVzLmJ5cmVmKHN5c19kaXIpLCAyNjApOgoJCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkVfV0lORE9XUwoKCQkJdm9sX2J1ZiA9IGN0eXBlcy5jcmVhdGVfdW5pY29kZV9idWZmZXIoMjYwKQoJCQlmc19idWYgPSBjdHlwZXMuY3JlYXRlX3VuaWNvZGVfYnVmZmVyKDI2MCkKCQkJc2VyaWFsX251bSA9IHdpbnR5cGVzLkRXT1JEKDApCgoJCQlpZiBub3QgazMyLkdldFZvbHVtZUluZm9ybWF0aW9uVyhjdHlwZXMuY193Y2hhcl9wKHN5c19kaXIudmFsdWVbOjNdKSwKCQkJCQl2b2xfYnVmLCBjdHlwZXMuc2l6ZW9mKHZvbF9idWYpLCBjdHlwZXMuYnlyZWYoc2VyaWFsX251bSksIE5vbmUsCgkJCQkJTm9uZSwgZnNfYnVmLCBjdHlwZXMuc2l6ZW9mKGZzX2J1ZikpOgoJCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkVfV0lORE9XUwoJCQlzZXJpYWxfbnVtID0gc2VyaWFsX251bS52YWx1ZQoJCQlzZXJpYWwgPSAiezA6MDR4fS17MTowNHh9Ii5mb3JtYXQoKHNlcmlhbF9udW0gPj4gMTYpICYgMHhGRkZGLCBzZXJpYWxfbnVtICYgMHhGRkZGKQoJCWVsc2U6CgkJCXNlcmlhbCA9IGdldF9oZGRfbGFiZWwoKQoKCQlyZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9NQUNISU5FX0lELCAiJXM6JXMiICUgKHNlcmlhbCwgbWFjaGluZV9uYW1lKSkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfcGF0Y2hfdXJsKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKCQlpZiBub3QgaXNpbnN0YW5jZShzZWxmLnRyYW5zcG9ydCwgSHR0cFRyYW5zcG9ydCk6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCW5ld191cmlfcGF0aCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1VSTClbJ3ZhbHVlJ10KCQlpZiBub3Qgc2VsZi50cmFuc3BvcnQucGF0Y2hfdXJpX3BhdGgobmV3X3VyaV9wYXRoKToKCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgkJcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgoJZGVmIF9jb3JlX2xvYWRsaWIoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCWRhdGFfdGx2ID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfREFUQSkKCQlpZiAoZGF0YV90bHZbJ3R5cGUnXSAmIFRMVl9NRVRBX1RZUEVfQ09NUFJFU1NFRCkgPT0gVExWX01FVEFfVFlQRV9DT01QUkVTU0VEOgoJCQlyZXR1cm4gRVJST1JfRkFJTFVSRQoKCQlzZWxmLmxhc3RfcmVnaXN0ZXJlZF9leHRlbnNpb24gPSBOb25lCgkJc3ltYm9sc19mb3JfZXh0ZW5zaW9ucyA9IHsnbWV0ZXJwcmV0ZXInOnNlbGZ9CgkJc3ltYm9sc19mb3JfZXh0ZW5zaW9ucy51cGRhdGUoRVhQT1JURURfU1lNQk9MUykKCQlpID0gY29kZS5JbnRlcmFjdGl2ZUludGVycHJldGVyKHN5bWJvbHNfZm9yX2V4dGVuc2lvbnMpCgkJaS5ydW5jb2RlKGNvbXBpbGUoZGF0YV90bHZbJ3ZhbHVlJ10sICcnLCAnZXhlYycpKQoJCWV4dGVuc2lvbl9uYW1lID0gc2VsZi5sYXN0X3JlZ2lzdGVyZWRfZXh0ZW5zaW9uCgoJCWlmIGV4dGVuc2lvbl9uYW1lOgoJCQljaGVja19leHRlbnNpb24gPSBsYW1iZGEgeDogeC5zdGFydHN3aXRoKGV4dGVuc2lvbl9uYW1lKQoJCQlsaWJfbWV0aG9kcyA9IGxpc3QoZmlsdGVyKGNoZWNrX2V4dGVuc2lvbiwgbGlzdChzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnMua2V5cygpKSkpCgkJCWZvciBtZXRob2QgaW4gbGliX21ldGhvZHM6CgkJCQlyZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9NRVRIT0QsIG1ldGhvZCkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfc2h1dGRvd24oc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCXJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX0JPT0wsIFRydWUpCgkJc2VsZi5ydW5uaW5nID0gRmFsc2UKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfdHJhbnNwb3J0X2FkZChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJbmV3X3RyYW5zcG9ydCA9IFRyYW5zcG9ydC5mcm9tX3JlcXVlc3QocmVxdWVzdCkKCQlzZWxmLnRyYW5zcG9ydF9hZGQobmV3X3RyYW5zcG9ydCkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfdHJhbnNwb3J0X2NoYW5nZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJbmV3X3RyYW5zcG9ydCA9IFRyYW5zcG9ydC5mcm9tX3JlcXVlc3QocmVxdWVzdCkKCQlzZWxmLnRyYW5zcG9ydF9hZGQobmV3X3RyYW5zcG9ydCkKCQlzZWxmLnNlbmRfcGFja2V0KHRsdl9wYWNrX3Jlc3BvbnNlKEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlKSkKCQlzZWxmLnRyYW5zcG9ydF9jaGFuZ2UobmV3X3RyYW5zcG9ydCkKCQlyZXR1cm4gTm9uZQoKCWRlZiBfY29yZV90cmFuc3BvcnRfbGlzdChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJaWYgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lID4gMDoKCQkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfU0VTU0lPTl9FWFAsIHNlbGYuc2Vzc2lvbl9leHBpcnlfZW5kIC0gdGltZS50aW1lKCkpCgkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfR1JPVVAsIHNlbGYudHJhbnNwb3J0LnRsdl9wYWNrX3RyYW5zcG9ydF9ncm91cCgpKQoKCQl0cmFuc3BvcnQgPSBzZWxmLnRyYW5zcG9ydF9uZXh0KCkKCQl3aGlsZSB0cmFuc3BvcnQgIT0gc2VsZi50cmFuc3BvcnQ6CgkJCXJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX1RSQU5TX0dST1VQLCB0cmFuc3BvcnQudGx2X3BhY2tfdHJhbnNwb3J0X2dyb3VwKCkpCgkJCXRyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQodHJhbnNwb3J0KQoJCXJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCWRlZiBfY29yZV90cmFuc3BvcnRfbmV4dChzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJbmV3X3RyYW5zcG9ydCA9IHNlbGYudHJhbnNwb3J0X25leHQoKQoJCWlmIG5ld190cmFuc3BvcnQgPT0gc2VsZi50cmFuc3BvcnQ6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCXNlbGYuc2VuZF9wYWNrZXQodGx2X3BhY2tfcmVzcG9uc2UoRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UpKQoJCXNlbGYudHJhbnNwb3J0X2NoYW5nZShuZXdfdHJhbnNwb3J0KQoJCXJldHVybiBOb25lCgoJZGVmIF9jb3JlX3RyYW5zcG9ydF9wcmV2KHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKCQluZXdfdHJhbnNwb3J0ID0gc2VsZi50cmFuc3BvcnRfcHJldigpCgkJaWYgbmV3X3RyYW5zcG9ydCA9PSBzZWxmLnRyYW5zcG9ydDoKCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgkJc2VsZi5zZW5kX3BhY2tldCh0bHZfcGFja19yZXNwb25zZShFUlJPUl9TVUNDRVNTLCByZXNwb25zZSkpCgkJc2VsZi50cmFuc3BvcnRfY2hhbmdlKG5ld190cmFuc3BvcnQpCgkJcmV0dXJuIE5vbmUKCglkZWYgX2NvcmVfdHJhbnNwb3J0X3JlbW92ZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJdXJsID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfVVJMKVsndmFsdWUnXQoJCWlmIHNlbGYudHJhbnNwb3J0LnVybCA9PSB1cmw6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCXRyYW5zcG9ydF9mb3VuZCA9IEZhbHNlCgkJZm9yIHRyYW5zcG9ydCBpbiBzZWxmLnRyYW5zcG9ydHM6CgkJCWlmIHRyYW5zcG9ydC51cmwgPT0gdXJsOgoJCQkJdHJhbnNwb3J0X2ZvdW5kID0gVHJ1ZQoJCQkJYnJlYWsKCQlpZiB0cmFuc3BvcnRfZm91bmQ6CgkJCXNlbGYudHJhbnNwb3J0cy5yZW1vdmUodHJhbnNwb3J0KQoJCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCQlyZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKCglkZWYgX2NvcmVfdHJhbnNwb3J0X3NldF90aW1lb3V0cyhzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJdGltZW91dF92YWx1ZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1NFU1NJT05fRVhQKS5nZXQoJ3ZhbHVlJykKCQlpZiBub3QgdGltZW91dF92YWx1ZSBpcyBOb25lOgoJCQlzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUgPSB0aW1lb3V0X3ZhbHVlCgkJCXNlbGYuc2Vzc2lvbl9leHBpcnlfZW5kID0gdGltZS50aW1lKCkgKyBzZWxmLnNlc3Npb25fZXhwaXJ5X3RpbWUKCQl0aW1lb3V0X3ZhbHVlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfVFJBTlNfQ09NTV9USU1FT1VUKS5nZXQoJ3ZhbHVlJykKCQlpZiB0aW1lb3V0X3ZhbHVlOgoJCQlzZWxmLnRyYW5zcG9ydC5jb21tdW5pY2F0aW9uX3RpbWVvdXQgPSB0aW1lb3V0X3ZhbHVlCgkJcmV0cnlfdmFsdWUgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19SRVRSWV9UT1RBTCkuZ2V0KCd2YWx1ZScpCgkJaWYgcmV0cnlfdmFsdWU6CgkJCXNlbGYudHJhbnNwb3J0LnJldHJ5X3RvdGFsID0gcmV0cnlfdmFsdWUKCQlyZXRyeV92YWx1ZSA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX1RSQU5TX1JFVFJZX1dBSVQpLmdldCgndmFsdWUnKQoJCWlmIHJldHJ5X3ZhbHVlOgoJCQlzZWxmLnRyYW5zcG9ydC5yZXRyeV93YWl0ID0gcmV0cnlfdmFsdWUKCgkJaWYgc2VsZi5zZXNzaW9uX2V4cGlyeV90aW1lID4gMDoKCQkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfVFJBTlNfU0VTU0lPTl9FWFAsIHNlbGYuc2Vzc2lvbl9leHBpcnlfZW5kIC0gdGltZS50aW1lKCkpCgkJcmVzcG9uc2UgKz0gc2VsZi50cmFuc3BvcnQudGx2X3BhY2tfdGltZW91dHMoKQoJCXJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCWRlZiBfY29yZV90cmFuc3BvcnRfc2xlZXAoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCXNlY29uZHMgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9UUkFOU19DT01NX1RJTUVPVVQpWyd2YWx1ZSddCgkJc2VsZi5zZW5kX3BhY2tldCh0bHZfcGFja19yZXNwb25zZShFUlJPUl9TVUNDRVNTLCByZXNwb25zZSkpCgkJaWYgc2Vjb25kczoKCQkJc2VsZi50cmFuc3BvcnQuZGVhY3RpdmF0ZSgpCgkJCXRpbWUuc2xlZXAoc2Vjb25kcykKCQkJaWYgbm90IHNlbGYudHJhbnNwb3J0LmFjdGl2YXRlKCk6CgkJCQlzZWxmLnRyYW5zcG9ydF9jaGFuZ2UoKQoJCXJldHVybiBOb25lCgoJZGVmIF9jb3JlX2NoYW5uZWxfb3BlbihzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJY2hhbm5lbF90eXBlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9UWVBFKQoJCWhhbmRsZXIgPSAnY2hhbm5lbF9vcGVuXycgKyBjaGFubmVsX3R5cGVbJ3ZhbHVlJ10KCQlpZiBoYW5kbGVyIG5vdCBpbiBzZWxmLmV4dGVuc2lvbl9mdW5jdGlvbnM6CgkJCXJldHVybiBlcnJvcl9yZXN1bHQoTm90SW1wbGVtZW50ZWRFcnJvciksIHJlc3BvbnNlCgkJaGFuZGxlciA9IHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uc1toYW5kbGVyXQoJCXJldHVybiBoYW5kbGVyKHJlcXVlc3QsIHJlc3BvbnNlKQoKCWRlZiBfY29yZV9jaGFubmVsX2Nsb3NlKHNlbGYsIHJlcXVlc3QsIHJlc3BvbnNlKToKCQljaGFubmVsX2lkID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9JRClbJ3ZhbHVlJ10KCQlpZiBjaGFubmVsX2lkIG5vdCBpbiBzZWxmLmNoYW5uZWxzOgoJCQlyZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKCQljaGFubmVsID0gc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQoJCWlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgc3VicHJvY2Vzcy5Qb3Blbik6CgkJCWNoYW5uZWwua2lsbCgpCgkJZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyRmlsZSk6CgkJCWNoYW5uZWwuY2xvc2UoKQoJCWVsaWYgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlclNvY2tldCk6CgkJCWNoYW5uZWwuY2xvc2UoKQoJCWVsc2U6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCWRlbCBzZWxmLmNoYW5uZWxzW2NoYW5uZWxfaWRdCgkJaWYgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgoJCQlzZWxmLmludGVyYWN0X2NoYW5uZWxzLnJlbW92ZShjaGFubmVsX2lkKQoJCXNlbGYuZGVidWdfcHJpbnQoJ1sqXSBjbG9zZWQgYW5kIHJlbW92ZWQgY2hhbm5lbCBpZDogJyArIHN0cihjaGFubmVsX2lkKSkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfY2hhbm5lbF9lb2Yoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCWNoYW5uZWxfaWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9DSEFOTkVMX0lEKVsndmFsdWUnXQoJCWlmIGNoYW5uZWxfaWQgbm90IGluIHNlbGYuY2hhbm5lbHM6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCWNoYW5uZWwgPSBzZWxmLmNoYW5uZWxzW2NoYW5uZWxfaWRdCgkJcmVzdWx0ID0gRmFsc2UKCQlpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyRmlsZSk6CgkJCXJlc3VsdCA9IGNoYW5uZWwudGVsbCgpID49IG9zLmZzdGF0KGNoYW5uZWwuZmlsZW5vKCkpLnN0X3NpemUKCQlyZXNwb25zZSArPSB0bHZfcGFjayhUTFZfVFlQRV9CT09MLCByZXN1bHQpCgkJcmV0dXJuIEVSUk9SX1NVQ0NFU1MsIHJlc3BvbnNlCgoJZGVmIF9jb3JlX2NoYW5uZWxfaW50ZXJhY3Qoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCWNoYW5uZWxfaWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9DSEFOTkVMX0lEKVsndmFsdWUnXQoJCWlmIGNoYW5uZWxfaWQgbm90IGluIHNlbGYuY2hhbm5lbHM6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCWNoYW5uZWwgPSBzZWxmLmNoYW5uZWxzW2NoYW5uZWxfaWRdCgkJdG9nZ2xlID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQk9PTClbJ3ZhbHVlJ10KCQlpZiB0b2dnbGU6CgkJCWlmIGNoYW5uZWxfaWQgaW4gc2VsZi5pbnRlcmFjdF9jaGFubmVsczoKCQkJCXNlbGYuaW50ZXJhY3RfY2hhbm5lbHMucmVtb3ZlKGNoYW5uZWxfaWQpCgkJCWVsc2U6CgkJCQlzZWxmLmludGVyYWN0X2NoYW5uZWxzLmFwcGVuZChjaGFubmVsX2lkKQoJCWVsaWYgY2hhbm5lbF9pZCBpbiBzZWxmLmludGVyYWN0X2NoYW5uZWxzOgoJCQlzZWxmLmludGVyYWN0X2NoYW5uZWxzLnJlbW92ZShjaGFubmVsX2lkKQoJCXJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCWRlZiBfY29yZV9jaGFubmVsX3JlYWQoc2VsZiwgcmVxdWVzdCwgcmVzcG9uc2UpOgoJCWNoYW5uZWxfaWQgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9DSEFOTkVMX0lEKVsndmFsdWUnXQoJCWxlbmd0aCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0xFTkdUSClbJ3ZhbHVlJ10KCQlpZiBjaGFubmVsX2lkIG5vdCBpbiBzZWxmLmNoYW5uZWxzOgoJCQlyZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKCQljaGFubmVsID0gc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQoJCWRhdGEgPSAnJwoJCWlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgU1REUHJvY2Vzcyk6CgkJCWlmIGNoYW5uZWwucG9sbCgpICE9IE5vbmU6CgkJCQlzZWxmLmhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoY2hhbm5lbF9pZCkKCQkJaWYgY2hhbm5lbC5zdGRvdXRfcmVhZGVyLmlzX3JlYWRfcmVhZHkoKToKCQkJCWRhdGEgPSBjaGFubmVsLnN0ZG91dF9yZWFkZXIucmVhZChsZW5ndGgpCgkJZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyRmlsZSk6CgkJCWRhdGEgPSBjaGFubmVsLnJlYWQobGVuZ3RoKQoJCWVsaWYgaXNpbnN0YW5jZShjaGFubmVsLCBNZXRlcnByZXRlclNvY2tldCk6CgkJCWRhdGEgPSBjaGFubmVsLnJlY3YobGVuZ3RoKQoJCWVsc2U6CgkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCXJlc3BvbnNlICs9IHRsdl9wYWNrKFRMVl9UWVBFX0NIQU5ORUxfREFUQSwgZGF0YSkKCQlyZXR1cm4gRVJST1JfU1VDQ0VTUywgcmVzcG9uc2UKCglkZWYgX2NvcmVfY2hhbm5lbF93cml0ZShzZWxmLCByZXF1ZXN0LCByZXNwb25zZSk6CgkJY2hhbm5lbF9pZCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0NIQU5ORUxfSUQpWyd2YWx1ZSddCgkJY2hhbm5lbF9kYXRhID0gcGFja2V0X2dldF90bHYocmVxdWVzdCwgVExWX1RZUEVfQ0hBTk5FTF9EQVRBKVsndmFsdWUnXQoJCWxlbmd0aCA9IHBhY2tldF9nZXRfdGx2KHJlcXVlc3QsIFRMVl9UWVBFX0xFTkdUSClbJ3ZhbHVlJ10KCQlpZiBjaGFubmVsX2lkIG5vdCBpbiBzZWxmLmNoYW5uZWxzOgoJCQlyZXR1cm4gRVJST1JfRkFJTFVSRSwgcmVzcG9uc2UKCQljaGFubmVsID0gc2VsZi5jaGFubmVsc1tjaGFubmVsX2lkXQoJCWwgPSBsZW4oY2hhbm5lbF9kYXRhKQoJCWlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgc3VicHJvY2Vzcy5Qb3Blbik6CgkJCWlmIGNoYW5uZWwucG9sbCgpICE9IE5vbmU6CgkJCQlzZWxmLmhhbmRsZV9kZWFkX3Jlc291cmNlX2NoYW5uZWwoY2hhbm5lbF9pZCkKCQkJCXJldHVybiBFUlJPUl9GQUlMVVJFLCByZXNwb25zZQoJCQljaGFubmVsLndyaXRlKGNoYW5uZWxfZGF0YSkKCQllbGlmIGlzaW5zdGFuY2UoY2hhbm5lbCwgTWV0ZXJwcmV0ZXJGaWxlKToKCQkJY2hhbm5lbC53cml0ZShjaGFubmVsX2RhdGEpCgkJZWxpZiBpc2luc3RhbmNlKGNoYW5uZWwsIE1ldGVycHJldGVyU29ja2V0KToKCQkJdHJ5OgoJCQkJbCA9IGNoYW5uZWwuc2VuZChjaGFubmVsX2RhdGEpCgkJCWV4Y2VwdCBzb2NrZXQuZXJyb3I6CgkJCQljaGFubmVsLmNsb3NlKCkKCQkJCXNlbGYuaGFuZGxlX2RlYWRfcmVzb3VyY2VfY2hhbm5lbChjaGFubmVsX2lkKQoJCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgkJZWxzZToKCQkJcmV0dXJuIEVSUk9SX0ZBSUxVUkUsIHJlc3BvbnNlCgkJcmVzcG9uc2UgKz0gdGx2X3BhY2soVExWX1RZUEVfTEVOR1RILCBsKQoJCXJldHVybiBFUlJPUl9TVUNDRVNTLCByZXNwb25zZQoKCWRlZiBjcmVhdGVfcmVzcG9uc2Uoc2VsZiwgcmVxdWVzdCk6CgkJcmVzcCA9IHN0cnVjdC5wYWNrKCc+SScsIFBBQ0tFVF9UWVBFX1JFU1BPTlNFKQoJCW1ldGhvZF90bHYgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9NRVRIT0QpCgkJcmVzcCArPSB0bHZfcGFjayhtZXRob2RfdGx2KQoKCQloYW5kbGVyX25hbWUgPSBtZXRob2RfdGx2Wyd2YWx1ZSddCgkJaWYgaGFuZGxlcl9uYW1lIGluIHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uczoKCQkJaGFuZGxlciA9IHNlbGYuZXh0ZW5zaW9uX2Z1bmN0aW9uc1toYW5kbGVyX25hbWVdCgkJCXRyeToKCQkJCXNlbGYuZGVidWdfcHJpbnQoJ1sqXSBydW5uaW5nIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lKQoJCQkJcmVzdWx0ID0gaGFuZGxlcihyZXF1ZXN0LCByZXNwKQoJCQkJaWYgcmVzdWx0IGlzIE5vbmU6CgkJCQkJcmV0dXJuCgkJCQlyZXN1bHQsIHJlc3AgPSByZXN1bHQKCQkJZXhjZXB0IEV4Y2VwdGlvbjoKCQkJCXNlbGYuZGVidWdfcHJpbnQoJ1stXSBtZXRob2QgJyArIGhhbmRsZXJfbmFtZSArICcgcmVzdWx0ZWQgaW4gYW4gZXJyb3InKQoJCQkJaWYgREVCVUdHSU5HOgoJCQkJCXRyYWNlYmFjay5wcmludF9leGMoZmlsZT1zeXMuc3RkZXJyKQoJCQkJcmVzdWx0ID0gZXJyb3JfcmVzdWx0KCkKCQkJZWxzZToKCQkJCWlmIHJlc3VsdCAhPSBFUlJPUl9TVUNDRVNTOgoJCQkJCXNlbGYuZGVidWdfcHJpbnQoJ1stXSBtZXRob2QgJyArIGhhbmRsZXJfbmFtZSArICcgcmVzdWx0ZWQgaW4gZXJyb3I6ICMnICsgc3RyKHJlc3VsdCkpCgkJZWxzZToKCQkJc2VsZi5kZWJ1Z19wcmludCgnWy1dIG1ldGhvZCAnICsgaGFuZGxlcl9uYW1lICsgJyB3YXMgcmVxdWVzdGVkIGJ1dCBkb2VzIG5vdCBleGlzdCcpCgkJCXJlc3VsdCA9IGVycm9yX3Jlc3VsdChOb3RJbXBsZW1lbnRlZEVycm9yKQoKCQlyZXFpZF90bHYgPSBwYWNrZXRfZ2V0X3RsdihyZXF1ZXN0LCBUTFZfVFlQRV9SRVFVRVNUX0lEKQoJCWlmIG5vdCByZXFpZF90bHY6CgkJCXJldHVybgoJCXJlc3AgKz0gdGx2X3BhY2socmVxaWRfdGx2KQoJCXJldHVybiB0bHZfcGFja19yZXNwb25zZShyZXN1bHQsIHJlc3ApCgppZiBub3QgaGFzYXR0cihvcywgJ2ZvcmsnKSBvciAoaGFzYXR0cihvcywgJ2ZvcmsnKSBhbmQgb3MuZm9yaygpID09IDApOgoJaWYgaGFzYXR0cihvcywgJ3NldHNpZCcpOgoJCXRyeToKCQkJb3Muc2V0c2lkKCkKCQlleGNlcHQgT1NFcnJvcjoKCQkJcGFzcwoJaWYgSFRUUF9DT05ORUNUSU9OX1VSTCBhbmQgaGFzX3VybGxpYjoKCQl0cmFuc3BvcnQgPSBIdHRwVHJhbnNwb3J0KEhUVFBfQ09OTkVDVElPTl9VUkwsIHByb3h5PUhUVFBfUFJPWFksIHVzZXJfYWdlbnQ9SFRUUF9VU0VSX0FHRU5UKQoJZWxzZToKCQlzID0gc29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCwgc29ja2V0LlNPQ0tfU1RSRUFNKQoJCXMuY29ubmVjdCgoJ3VzLnR1bm5lbC5teS5pZCcsMTEyMSkpCgoJCXRyYW5zcG9ydCA9IFRjcFRyYW5zcG9ydC5mcm9tX3NvY2tldChzKQoJbWV0ID0gUHl0aG9uTWV0ZXJwcmV0ZXIodHJhbnNwb3J0KQoJIyBQQVRDSC1TRVRVUC1UUkFOU1BPUlRTICMKCW1ldC5ydW4oKQo=')))